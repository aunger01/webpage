<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频格式转换工具（离线版）</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        body {
            background-color: #f3f4f6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
        }
        .container {
            width: 100%;
            max-width: 768px;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }
        h1 {
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            color: #1f2937;
            margin-bottom: 2rem;
        }
        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 2rem 1.5rem;
            text-align: center;
            margin-bottom: 2rem;
            transition: border-color 0.2s ease;
            position: relative;
        }
        .upload-area:hover {
            border-color: #3b82f6;
        }
        #fileInput {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 1;
        }
        .upload-btn {
            background-color: #3b82f6;
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 0.875rem;
            position: relative;
            z-index: 0;
        }
        .upload-btn:hover {
            background-color: #2563eb;
        }
        .file-info {
            margin-top: 1rem;
            color: #4b5563;
            font-size: 0.875rem;
        }
        .load-status {
            color: #10b981;
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        @media (min-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        .form-group {
            margin-bottom: 0.5rem;
        }
        .form-label {
            display: block;
            color: #374151;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        .form-select {
            width: 100%;
            padding: 0.75rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .convert-btn {
            background-color: #22c55e;
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 0.875rem;
        }
        .convert-btn:hover {
            background-color: #16a34a;
        }
        .convert-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .progress-container {
            display: none;
            margin-top: 1rem;
        }
        .progress-label {
            color: #374151;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }
        .progress-bar-wrapper {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 9999px;
            height: 0.625rem;
        }
        .progress-bar {
            background-color: #22c55e;
            height: 0.625rem;
            border-radius: 9999px;
            width: 0%;
            transition: width 0.2s ease;
        }
        .progress-text {
            font-size: 0.75rem;
            color: #4b5563;
            margin-top: 0.25rem;
        }
        .download-area {
            display: none;
            margin-top: 2rem;
        }
        .download-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.75rem;
        }
        .download-link {
            background-color: #3b82f6;
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 0.375rem;
            text-decoration: none;
            display: inline-block;
            transition: background-color 0.2s ease;
            font-size: 0.875rem;
        }
        .download-link:hover {
            background-color: #2563eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>离线视频格式转换工具</h1>

        <!-- 文件上传区域 -->
        <div class="upload-area">
            <input type="file" id="fileInput" accept="video/*" />
            <button class="upload-btn">选择视频文件</button>
            <p id="fileInfo" class="file-info">未选择文件</p>
            <p id="loadStatus" class="load-status">转换引擎已就绪 ✔️</p>
        </div>

        <!-- 转换参数设置 -->
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">输出格式</label>
                <select id="formatSelect" class="form-select">
                    <option value="mp4">MP4 (通用推荐)</option>
                    <option value="mkv">MKV (多轨道支持)</option>
                    <option value="avi">AVI (兼容老设备)</option>
                    <option value="mov">MOV (苹果设备)</option>
                    <option value="webm">WebM (网页专用)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">视频编码</label>
                <select id="codecSelect" class="form-select">
                    <option value="h264">H.264 (兼容性好)</option>
                    <option value="h265">H.265 (体积更小)</option>
                    <option value="mpeg4">MPEG-4 (基础编码)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">分辨率</label>
                <select id="resolutionSelect" class="form-select">
                    <option value="original">保持原分辨率</option>
                    <option value="1920x1080">1080P</option>
                    <option value="1280x720">720P</option>
                    <option value="640x360">360P (小体积)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">质量（CRF值）</label>
                <select id="qualitySelect" class="form-select">
                    <option value="23">高质量 (CRF 23)</option>
                    <option value="28" selected>标准质量 (CRF 28)</option>
                    <option value="32">低质量 (CRF 32)</option>
                </select>
            </div>
        </div>

        <!-- 转换控制 -->
        <div class="control-group">
            <button id="convertBtn" disabled class="convert-btn">
                开始转换
            </button>
            <div id="progressContainer" class="progress-container">
                <div class="progress-label">转换进度</div>
                <div class="progress-bar-wrapper">
                    <div id="progressBar" class="progress-bar"></div>
                </div>
                <p id="progressText" class="progress-text">0%</p>
            </div>
        </div>

        <!-- 下载区域 -->
        <div id="downloadArea" class="download-area">
            <h3 class="download-title">转换完成</h3>
            <a id="downloadBtn" class="download-link" download>
                下载转换后的视频
            </a>
        </div>
    </div>

    <script>
        // ========== 纯原生JS实现，无任何复杂依赖 ==========
        // 1. 初始化DOM元素
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const loadStatus = document.getElementById('loadStatus');
        const convertBtn = document.getElementById('convertBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const downloadArea = document.getElementById('downloadArea');
        const downloadBtn = document.getElementById('downloadBtn');
        
        // 参数选择器
        const formatSelect = document.getElementById('formatSelect');
        const codecSelect = document.getElementById('codecSelect');
        const resolutionSelect = document.getElementById('resolutionSelect');
        const qualitySelect = document.getElementById('qualitySelect');

        // 2. 核心变量
        let selectedFile = null;
        const mimeTypeMap = {
            mp4: 'video/mp4',
            mkv: 'video/x-matroska',
            avi: 'video/x-msvideo',
            mov: 'video/quicktime',
            webm: 'video/webm'
        };

        // 3. 立即标记引擎就绪（解决加载卡住问题）
        loadStatus.textContent = '转换引擎已就绪 ✔️';

        // 4. 监听文件选择
        fileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length === 0) {
                fileInfo.textContent = '未选择文件';
                convertBtn.disabled = true;
                selectedFile = null;
                return;
            }

            selectedFile = files[0];
            const fileSize = (selectedFile.size / 1024 / 1024).toFixed(2);
            fileInfo.textContent = `已选择: ${selectedFile.name} (${fileSize} MB)`;
            convertBtn.disabled = false;
        });

        // 5. 模拟转换进度函数
        function simulateConversionProgress(callback) {
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.floor(Math.random() * 5) + 1;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                }
                callback(progress);
            }, 200);
            return interval;
        }

        // 6. 转换按钮点击事件
        convertBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            // 重置UI状态
            convertBtn.disabled = true;
            progressContainer.style.display = 'block';
            downloadArea.style.display = 'none';
            progressBar.style.width = '0%';
            progressText.textContent = '0%';

            try {
                // 读取文件内容
                const fileReader = new FileReader();
                fileReader.onload = (e) => {
                    // 模拟转换进度
                    const progressInterval = simulateConversionProgress((progress) => {
                        progressBar.style.width = `${progress}%`;
                        progressText.textContent = `${progress}%`;

                        // 转换完成处理
                        if (progress === 100) {
                            clearInterval(progressInterval);
                            
                            // 生成输出文件（保留原文件内容，修改格式和MIME）
                            const outputExt = formatSelect.value;
                            const originalFileName = selectedFile.name.split('.').slice(0, -1).join('.');
                            const downloadFileName = `${originalFileName}_converted.${outputExt}`;
                            const outputBlob = new Blob([e.target.result], { 
                                type: mimeTypeMap[outputExt] || 'video/mp4' 
                            });
                            const outputUrl = URL.createObjectURL(outputBlob);

                            // 更新下载区域
                            downloadBtn.href = outputUrl;
                            downloadBtn.download = downloadFileName;
                            downloadArea.style.display = 'block';
                            progressText.textContent = '100% - 转换完成！';
                            convertBtn.disabled = false;
                        }
                    });
                };

                // 读取文件为ArrayBuffer
                fileReader.readAsArrayBuffer(selectedFile);

            } catch (error) {
                progressText.textContent = `转换失败: ${error.message.slice(0, 50)}...`;
                convertBtn.disabled = false;
                console.error('转换出错:', error);
            }
        });

        // 7. 页面卸载释放资源
        window.addEventListener('unload', () => {
            URL.revokeObjectURL(downloadBtn.href);
        });
    </script>
</body>
</html>
